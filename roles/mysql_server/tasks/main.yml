---
- name: Import MySQL GPG key
  become: true
  shell: |
    curl -s {{ mysql_gpg_key_url }} | gpg --batch --yes --dearmor -o /usr/share/keyrings/mysql-apt-config.gpg
  when: >
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')
  args:
    creates: /usr/share/keyrings/mysql-apt-config.gpg

- name: Adding the MySQL APT Repository for Ubuntu 24.04
  become: true
  copy:
    dest: /etc/apt/sources.list.d/mysql.list
    content: |
      deb [signed-by=/usr/share/keyrings/mysql-apt-config.gpg] https://repo.mysql.com/apt/ubuntu/ noble mysql-8.4-lts
  when: >
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')

- name: Update APT package index
  become: true
  apt:
    update_cache: yes
  when: >
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')
  changed_when: false

- name: Generate MySQL root password
  command: openssl rand -base64 12
  register: root_pass
  when: >
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')
  changed_when: false

- name: Set the MySQL root password as a fact
  set_fact:
    my_root_pass: "{{ root_pass.stdout }}"
  when: >
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')

- name: Install MySQL
  become: true
  shell: |
    echo "mysql-community-server mysql-community-server/root-pass password {{my_root_pass}}" | debconf-set-selections
    echo "mysql-community-server mysql-community-server/re-root-pass password {{my_root_pass}}" | debconf-set-selections
    apt-get install -y mysql-community-server
  when: >
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')
  changed_when: false

- name: Start MySQL Server
  become: true
  service:
    name: mysql
    state: started
    enabled: yes
  when: >
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')
  changed_when: false

- name: Install MySQL Client
  become: true
  apt:
    name: mysql-community-client
    state: present
  when: >
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')
  changed_when: false

- name: Check if MySQL configuration file exists
  stat:
    path: "{{ ansible_env.HOME }}/.my.cnf"
  register: my_cnf

- name: Configure MySQL for current user
  copy:
    dest: "{{ ansible_env.HOME }}/.my.cnf"
    content: |
      [client]
      host     = 127.0.0.1
      user     = root
      password = {{my_root_pass}}
    mode: '0600'
  when: >
    (
    (ansible_distribution == 'Ubuntu' and ansible_distribution_version == '24.04') or 
    (ansible_distribution == 'Debian' and ansible_distribution_version == '12')
    ) and my_cnf.stat.exists == False
  changed_when: false
